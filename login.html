<!doctype html>
<html class="no-js" lang="de">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>E3DC Login</title>
  <link rel="stylesheet" href="static/css/login.css">
  <meta name="description" content="E3DC Solar Dashboard - Login">

  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" href="/icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="icon.png">

  <meta name="theme-color" content="#1a1a2e">
</head>

<body>
  <div class="login-container">
    <div class="login-box">
      <div class="login-header">
        <svg class="logo-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm0-5a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1zm0 18a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0v-2a1 1 0 0 1 1-1zm9-9a1 1 0 0 1-1 1h-2a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1zM5 12a1 1 0 0 1-1 1H2a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1z"/>
        </svg>
        <h1>E3DC Solar Dashboard</h1>
        <p class="subtitle">Secure Credential Management</p>
      </div>

      <!-- Status-Nachricht -->
      <div id="status-message" class="status-message hidden"></div>

      <!-- Setup-Modus (Erstmalige Einrichtung) -->
      <div id="setup-mode" class="form-section hidden">
        <div class="info-box">
          <h2>Erstmalige Einrichtung</h2>
          <p>Bitte geben Sie Ihre E3DC-Zugangsdaten ein. Diese werden verschlüsselt gespeichert.</p>
        </div>

        <form id="setup-form">
          <div class="form-group">
            <label for="setup-username">E3DC Benutzername</label>
            <input
              type="text"
              id="setup-username"
              name="username"
              required
              autocomplete="username"
              placeholder="z.B. ihre.email@example.com"
            >
          </div>

          <div class="form-group">
            <label for="setup-password">E3DC Passwort</label>
            <input
              type="password"
              id="setup-password"
              name="password"
              required
              autocomplete="current-password"
              placeholder="Ihr E3DC-Passwort"
            >
          </div>

          <div class="form-group">
            <label for="setup-dashboard-url">Dashboard URL</label>
            <input
              type="url"
              id="setup-dashboard-url"
              name="dashboard_url"
              required
              placeholder="https://my.e3dc.com/dashboard/overview/..."
            >
            <small>Die URL zu Ihrem E3DC Dashboard</small>
          </div>

          <div class="divider"></div>

          <div class="form-group">
            <label for="setup-master-password">Master-Passwort erstellen</label>
            <input
              type="password"
              id="setup-master-password"
              name="master_password"
              required
              minlength="8"
              autocomplete="new-password"
              placeholder="Mindestens 8 Zeichen"
            >
            <small>Dieses Passwort wird zum Ver- und Entschlüsseln Ihrer Zugangsdaten verwendet</small>
          </div>

          <div class="form-group">
            <label for="setup-master-password-confirm">Master-Passwort bestätigen</label>
            <input
              type="password"
              id="setup-master-password-confirm"
              name="master_password_confirm"
              required
              minlength="8"
              autocomplete="new-password"
              placeholder="Master-Passwort wiederholen"
            >
          </div>

          <div class="warning-box">
            <strong>Wichtig:</strong> Bewahren Sie Ihr Master-Passwort sicher auf!
            Ohne dieses Passwort können Ihre gespeicherten Zugangsdaten nicht wiederhergestellt werden.
          </div>

          <button type="submit" class="btn btn-primary">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
            </svg>
            Einrichten und Speichern
          </button>
        </form>
      </div>

      <!-- Unlock-Modus (Normaler Login) -->
      <div id="unlock-mode" class="form-section hidden">
        <div class="info-box info-success">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>
          </svg>
          <div>
            <strong>Credentials gespeichert</strong>
            <p>Ihre E3DC-Zugangsdaten sind verschlüsselt gespeichert.</p>
          </div>
        </div>

        <form id="unlock-form">
          <div class="form-group">
            <label for="unlock-master-password">Master-Passwort</label>
            <input
              type="password"
              id="unlock-master-password"
              name="master_password"
              required
              autocomplete="current-password"
              placeholder="Master-Passwort eingeben"
              autofocus
            >
          </div>

          <button type="submit" class="btn btn-primary">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
            </svg>
            Entsperren
          </button>
        </form>

        <div class="reset-section">
          <a href="#" id="reset-credentials" class="link-danger">
            Zugangsdaten zurücksetzen
          </a>
          <small>Löscht die gespeicherten Zugangsdaten. Sie müssen diese danach neu eingeben.</small>
        </div>
      </div>

      <!-- Lade-Animation -->
      <div id="loading" class="loading hidden">
        <div class="spinner"></div>
        <p>Wird geladen...</p>
      </div>
    </div>

    <footer class="login-footer">
      <p>E3DC Solar Dashboard | Ihre Daten werden lokal verschlüsselt gespeichert</p>
    </footer>
  </div>

  <script>
    /**
     * Login-Logik für E3DC Dashboard
     */
    class LoginManager {
      constructor() {
        this.setupMode = document.getElementById('setup-mode');
        this.unlockMode = document.getElementById('unlock-mode');
        this.loading = document.getElementById('loading');
        this.statusMessage = document.getElementById('status-message');

        this.init();
      }

      init() {
        this.checkCredentialStatus();
        this.setupEventListeners();
      }

      setupEventListeners() {
        // Setup-Form
        const setupForm = document.getElementById('setup-form');
        if (setupForm) {
          setupForm.addEventListener('submit', (e) => this.handleSetup(e));
        }

        // Unlock-Form
        const unlockForm = document.getElementById('unlock-form');
        if (unlockForm) {
          unlockForm.addEventListener('submit', (e) => this.handleUnlock(e));
        }

        // Reset-Link
        const resetLink = document.getElementById('reset-credentials');
        if (resetLink) {
          resetLink.addEventListener('click', (e) => this.handleReset(e));
        }
      }

      async checkCredentialStatus() {
        try {
          this.showLoading(true);

          const response = await fetch('/api/credentials/status');
          const data = await response.json();

          if (data.exists) {
            this.showUnlockMode(data.migration_available);
          } else {
            this.showSetupMode(data.migration_data);
          }
        } catch (err) {
          this.showError('Verbindungsfehler: ' + err.message);
        } finally {
          this.showLoading(false);
        }
      }

      showSetupMode(migrationData = null) {
        this.setupMode.classList.remove('hidden');
        this.unlockMode.classList.add('hidden');

        // Vorausfüllen mit Migrations-Daten
        if (migrationData) {
          document.getElementById('setup-username').value = migrationData.username || '';
          document.getElementById('setup-dashboard-url').value = migrationData.dashboard_url || '';

          this.showInfo('Zugangsdaten aus config.json gefunden. Bitte erstellen Sie ein Master-Passwort.');
        }
      }

      showUnlockMode(migrationAvailable = false) {
        this.setupMode.classList.add('hidden');
        this.unlockMode.classList.remove('hidden');

        if (migrationAvailable) {
          this.showWarning('Eine Migration ist ausstehend. Nach dem Entsperren werden die alten Daten aus config.json entfernt.');
        }
      }

      async handleSetup(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const data = {
          username: formData.get('username'),
          password: formData.get('password'),
          dashboard_url: formData.get('dashboard_url'),
          master_password: formData.get('master_password')
        };

        const confirmPassword = formData.get('master_password_confirm');

        // Validierung
        if (data.master_password !== confirmPassword) {
          this.showError('Master-Passwörter stimmen nicht überein!');
          return;
        }

        if (data.master_password.length < 8) {
          this.showError('Master-Passwort muss mindestens 8 Zeichen lang sein!');
          return;
        }

        try {
          this.showLoading(true);

          const response = await fetch('/api/credentials/setup', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
          });

          const result = await response.json();

          if (response.ok && result.success) {
            this.showSuccess('Zugangsdaten erfolgreich gespeichert! Weiterleitung...');
            setTimeout(() => {
              window.location.href = '/dashboard';
            }, 1500);
          } else {
            this.showError(result.error || 'Fehler beim Speichern der Zugangsdaten');
          }
        } catch (err) {
          this.showError('Verbindungsfehler: ' + err.message);
        } finally {
          this.showLoading(false);
        }
      }

      async handleUnlock(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const masterPassword = formData.get('master_password');

        try {
          this.showLoading(true);

          const response = await fetch('/api/credentials/unlock', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ master_password: masterPassword })
          });

          const result = await response.json();

          if (response.ok && result.success) {
            this.showSuccess('Erfolgreich entsperrt! Weiterleitung...');
            setTimeout(() => {
              window.location.href = '/dashboard';
            }, 1000);
          } else {
            this.showError(result.error || 'Falsches Master-Passwort!');
            // Passwort-Feld leeren
            document.getElementById('unlock-master-password').value = '';
          }
        } catch (err) {
          this.showError('Verbindungsfehler: ' + err.message);
        } finally {
          this.showLoading(false);
        }
      }

      async handleReset(event) {
        event.preventDefault();

        if (!confirm('Möchten Sie wirklich alle gespeicherten Zugangsdaten löschen? Sie müssen diese danach neu eingeben.')) {
          return;
        }

        try {
          this.showLoading(true);

          const response = await fetch('/api/credentials/reset', {
            method: 'POST'
          });

          const result = await response.json();

          if (response.ok && result.success) {
            this.showSuccess('Zugangsdaten gelöscht. Seite wird neu geladen...');
            setTimeout(() => {
              window.location.reload();
            }, 1500);
          } else {
            this.showError(result.error || 'Fehler beim Löschen der Zugangsdaten');
          }
        } catch (err) {
          this.showError('Verbindungsfehler: ' + err.message);
        } finally {
          this.showLoading(false);
        }
      }

      showLoading(show) {
        if (show) {
          this.loading.classList.remove('hidden');
          this.setupMode.style.opacity = '0.5';
          this.unlockMode.style.opacity = '0.5';
        } else {
          this.loading.classList.add('hidden');
          this.setupMode.style.opacity = '1';
          this.unlockMode.style.opacity = '1';
        }
      }

      showMessage(message, type) {
        this.statusMessage.textContent = message;
        this.statusMessage.className = `status-message status-${type}`;
        this.statusMessage.classList.remove('hidden');

        setTimeout(() => {
          this.statusMessage.classList.add('hidden');
        }, 5000);
      }

      showSuccess(message) {
        this.showMessage(message, 'success');
      }

      showError(message) {
        this.showMessage(message, 'error');
      }

      showWarning(message) {
        this.showMessage(message, 'warning');
      }

      showInfo(message) {
        this.showMessage(message, 'info');
      }
    }

    // Login-Manager beim Laden initialisieren
    document.addEventListener('DOMContentLoaded', () => {
      new LoginManager();
    });
  </script>
</body>

</html>
